<div class="page shop-page">
  <p-card styleClass="shop-card">
    <div class="shop-tools">
      <p-dropdown
        [options]="doneFilterOptions"
        [(ngModel)]="doneFilter"
        [ngModelOptions]="{ standalone: true }"
        [appendTo]="'body'"
        styleClass="filter"
        placeholder="Filter"
      ></p-dropdown>

      <div class="counts">
        <span class="count">{{ openCount }} tilbage</span>
        <span class="count muted" *ngIf="doneCount">{{ doneCount }} i kurv</span>
      </div>

      <button
        pButton
        type="button"
        icon="pi pi-refresh"
        rounded
        text
        [loading]="loadingEntries"
        (click)="loadEntries()"
        aria-label="Opdater"
      ></button>
    </div>

    <div class="groups" *ngIf="groupedEntries.length; else empty">
      <div class="group" *ngFor="let group of groupedEntries">
        <div class="group-head">{{ group.area }}</div>

        <div class="rows">
          <div
            class="row"
            *ngFor="let entry of group.entries"
            [class.done]="entry.isDone"
            [class.updating]="isUpdating(entry)"
            [class.confirming]="confirmingEntryId === entry.id"
            [class.just-saved]="rowFeedbackState(entry.id) === 'saved'"
            [class.just-error]="rowFeedbackState(entry.id) === 'error'"
            (click)="toggleDone(entry)"
            tabindex="0"
            role="button"
            (keydown.enter)="toggleDone(entry); $event.preventDefault()"
            (keydown.space)="toggleDone(entry); $event.preventDefault()"
          >
            <div class="check" [class.done]="entry.isDone"><i class="pi" [ngClass]="entry.isDone ? 'pi-check' : 'pi-circle'"></i></div>
            <div class="main">
              <div class="name">{{ entry.itemId ? entry.itemName : entry.note }}</div>
              <div class="meta" *ngIf="entry.amount || (entry.note && entry.itemId)">
                <span *ngIf="entry.amount">{{ entry.amount }}</span>
                <span *ngIf="entry.note && entry.itemId">{{ entry.note }}</span>
              </div>
            </div>
            <div class="status" [class.confirm-actions]="confirmingEntryId === entry.id && !entry.isDone">
              <ng-container *ngIf="confirmingEntryId === entry.id && !entry.isDone; else feedbackIcons">
                <button
                  type="button"
                  class="icon-btn ok"
                  aria-label="Bekræft færdig"
                  title="Bekræft"
                  (click)="confirmDone(entry); $event.stopPropagation()"
                >
                  <i class="pi pi-check"></i>
                </button>
                <button
                  type="button"
                  class="icon-btn cancel"
                  aria-label="Annuller"
                  title="Annuller"
                  (click)="cancelConfirm(entry.id); $event.stopPropagation()"
                >
                  <i class="pi pi-times"></i>
                </button>
              </ng-container>
              <ng-template #feedbackIcons>
                <i *ngIf="rowFeedbackState(entry.id) === 'saving'" class="pi pi-spin pi-spinner" title="Gemmer…"></i>
                <i *ngIf="rowFeedbackState(entry.id) === 'saved'" class="pi pi-check" title="Gemt"></i>
                <i *ngIf="rowFeedbackState(entry.id) === 'error'" class="pi pi-exclamation-triangle" title="Ikke gemt"></i>
              </ng-template>
            </div>
          </div>
        </div>
      </div>
    </div>

    <ng-template #empty>
      <div class="empty">
        <i class="pi pi-inbox"></i>
        <p>Ingen varer på listen endnu.</p>
      </div>
    </ng-template>
  </p-card>
</div>
